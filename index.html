<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moon Byul Spending Tracker</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e6e8f0;
      --text:#111827;
      --muted:#6b7280;
      --accent:#7c3aed;

      --concert:#a855f7;   /* Í≥µÏó∞ */
      --traffic:#0ea5e9;   /* ÍµêÌÜµ */
      --goods:#f59e0b;     /* ÍµøÏ¶à */
      --stay:#22c55e;      /* ÏàôÎ∞ï */
      --sub:#ef4444;       /* Ï†ïÍ∏∞Í≤∞Ï†ú */

      --shadow:0 6px 20px rgba(17,24,39,0.06);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom:12px;
    }

    h1{ margin:0; font-size:22px; }
    .subline{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }

    button{
      background:var(--card);
      border:1px solid var(--line);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      color:var(--text);
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      font-weight:700;
    }
    button:active{ transform:scale(0.98); }

    .btn-gray{
      border-color:var(--line);
      color:var(--muted);
      background:#fff;
      font-weight:800;
    }

    .btn-active{
      border-color: rgba(124,58,237,0.55) !important;
      color: var(--accent) !important;
      background: rgba(124,58,237,0.06) !important;
    }

    .board{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }

    .board-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .board-title{
      font-size:14px;
      font-weight:900;
      margin:0;
    }

    .board-cards{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:10px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fbfbfd;
    }
    .card .k{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .card .v{
      margin-top:6px;
      font-size:16px;
      font-weight:900;
      letter-spacing:-0.2px;
    }

    .progress{
      margin-top:12px;
      height:12px;
      background:#eef0f6;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;
      width:0%;
      background:rgba(124,58,237,0.65);
    }
    .progress-meta{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      flex-wrap:wrap;
    }

    .layout{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr 1fr;
      gap:12px;
      align-items:start;
    }

    .box{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .box-head{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:#fafafa;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .box-title{
      margin:0;
      font-size:14px;
      font-weight:900;
    }

    .monthbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      width:100%;
    }
    #prevMonth{ justify-self:start; }
    #nextMonth{ justify-self:end; }

    #monthBtn{
      justify-self:center;
      text-align:center;
      border-color:var(--line);
      background:#fff;
      font-weight:900;
      min-width:170px;
      color:var(--text);
    }

    #prevMonth, #nextMonth{
      border-color:var(--line);
      color:var(--accent);
      font-weight:900;
    }

    /* Calendar */
    .dow, .cal{
      display:grid;
      grid-template-columns: repeat(7, 14.285714%);
    }
    .dow{
      padding:0 6px;
    }
    .dow div{
      padding:10px 8px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      text-align:left;
    }
    .cal{
      border-top:1px solid var(--line);
    }
    .cell{
      min-height:92px;
      padding:8px;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      cursor:pointer;
    }
    .cell:nth-child(7n){ border-right:none; }
    .other-month{
      background:rgba(0,0,0,0.02);
      color:rgba(17,24,39,0.4);
    }
    .day{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .today{
      outline:2px solid rgba(124,58,237,0.25);
      outline-offset:-2px;
    }
    .selected{
      outline:2px solid rgba(124,58,237,0.6);
      outline-offset:-2px;
      background:rgba(124,58,237,0.05);
    }
    .dots{
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
    }

    /* Box body */
    .box-body{
      padding:14px;
    }

    .date-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .date-title{
      margin:0;
      font-size:14px;
      font-weight:900;
    }

    .sumchip{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      white-space:nowrap;
    }

    .items{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* click-to-reveal actions */
    .tx{
      position:relative;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fbfbfd;
      padding:12px;
      cursor:pointer;
      overflow:hidden;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }

    .tx-grid{
      display:grid;
      grid-template-columns: 70px 1fr;
      gap:10px;
      align-items:start;
    }

    .tx-amt{
      font-weight:900;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .tx-main{ min-width:0; }
    .tx-title{
      margin:0;
      font-weight:900;
      font-size:14px;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .tx-meta{
      margin-top:6px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      font-weight:900;
      color:var(--text);
      white-space:nowrap;
    }
    .pill .dot{ width:10px; height:10px; }

    .tx-actions{
      position:absolute;
      right:12px;
      bottom:12px;
      display:flex;
      gap:8px;
      opacity:0;
      transform:translateY(6px);
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
    }

    .tx.is-open{
      background:#f7f6fb;
    }
    .tx.is-open .tx-content{
      opacity:0.45;
      transition:opacity .15s ease;
    }
    .tx.is-open .tx-actions{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }

    .iconbtn{
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
    }
    .iconbtn.edit{
      color:var(--accent);
      border-color:rgba(124,58,237,0.25);
    }
    .iconbtn.del{
      color:#ef4444;
      border-color:rgba(239,68,68,0.25);
    }

    /* Box3: monthly totals + chart */
    .chart-wrap{
      padding:14px;
    }

    .cat-totals{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }
    .cat-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fbfbfd;
    }
    .cat-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .cat-val{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    canvas{
      width:100%;
      height:260px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
    }

    /* legend: smaller + one line scroll on mobile */
    .legend{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      overflow-x:auto;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      user-select:none;
      -webkit-overflow-scrolling:touch;
    }
    .legend::-webkit-scrollbar{ height:6px; }
    .legend::-webkit-scrollbar-thumb{ background:rgba(107,114,128,0.25); border-radius:999px; }
    .legend .leg{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      cursor:default;
      font-size:11px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .legend .leg .dot{ width:9px; height:9px; }

    /* Annual */
    .annual{
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .annual-body{
      padding:14px;
    }
    .annual-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:start;
    }

    /* Bottom actions */
    .bottom-actions{
      margin-top:14px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .bottom-actions button{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      border-color:var(--line);
      background:#fff;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      background:#fafafa;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modal-title{
      margin:0;
      font-size:14px;
      font-weight:900;
    }
    .modal-body{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font:inherit;
      background:#fff;
      outline:none;
    }
    textarea{
      min-height:86px;
      resize:vertical;
    }
    .modal-actions{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      background:#fff;
    }
    .modal-actions .danger{
      color:#ef4444;
      border-color:rgba(239,68,68,0.25);
    }
    .modal-actions .accent{
      color:var(--accent);
      border-color:rgba(124,58,237,0.25);
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      canvas{ height:240px; }
      .board-cards{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }

    @media (max-width: 640px){
      header{ flex-direction:column; align-items:flex-start; }
      .cell{ min-height:78px; }
      .tx-grid{ grid-template-columns:64px 1fr; }
      #monthBtn{ min-width:160px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üåô Î¨∏Î≥Ñ ÏÜåÎπÑ Í¥ÄÎ¶¨</h1>
        <div class="subline">Ïõî ÏòàÏÇ∞ 25ÎßåÏõê + Ïù¥Ïõî(ÎÇ®ÏúºÎ©¥ + / Ï¥àÍ≥ºÌïòÎ©¥ -) ¬∑ Î°úÏª¨ Ï†ÄÏû•</div>
      </div>
    </header>

    <section class="board">
      <div class="board-top">
        <p class="board-title" id="boardMonthTitle">2026ÎÖÑ 1Ïõî ÏòàÏÇ∞</p>
        <button class="btn-gray" id="toggleYearBtn" type="button">Ïó∞Í∞Ñ ÏöîÏïΩ Î≥¥Í∏∞</button>
      </div>

      <div class="board-cards">
        <div class="card">
          <div class="k">Ïù¥Î≤àÎã¨ ÏòàÏÇ∞</div>
          <div class="v" id="vBudget">0Ïõê</div>
        </div>
        <div class="card">
          <div class="k">Ïù¥Î≤àÎã¨ ÏÇ¨Ïö©</div>
          <div class="v" id="vSpent">0Ïõê</div>
        </div>
        <div class="card">
          <div class="k">Ïù¥Î≤àÎã¨ ÏûîÏï°</div>
          <div class="v" id="vRemain">0Ïõê</div>
        </div>
        <div class="card">
          <div class="k">Îã§ÏùåÎã¨ ÏòàÏÉÅ ÏòàÏÇ∞</div>
          <div class="v" id="vNextBudget">0Ïõê</div>
        </div>
      </div>

      <div class="progress" aria-label="Ïù¥Î≤àÎã¨ ÏòàÏÇ∞ ÏßÑÌñâÎ•†">
        <div class="bar" id="progressBar"></div>
      </div>
      <div class="progress-meta">
        <div id="progressLeft">0%</div>
        <div id="progressRight">0Ïõê / 0Ïõê</div>
      </div>
    </section>

    <section class="layout">
      <!-- Box 1 -->
      <section class="box">
        <div class="box-head">
          <div class="monthbar">
            <button id="prevMonth" type="button" aria-label="Ïù¥Ï†Ñ Îã¨">‚óÄ</button>
            <button id="monthBtn" type="button" aria-label="ÌòÑÏû¨ Îã¨Î°ú Ïù¥Îèô">2026ÎÖÑ 1Ïõî</button>
            <button id="nextMonth" type="button" aria-label="Îã§Ïùå Îã¨">‚ñ∂</button>
          </div>
        </div>

        <div class="dow">
          <div>Ïùº</div><div>Ïõî</div><div>Ìôî</div><div>Ïàò</div><div>Î™©</div><div>Í∏à</div><div>ÌÜ†</div>
        </div>
        <div class="cal" id="calendar"></div>
      </section>

      <!-- Box 2 -->
      <section class="box">
        <div class="box-head">
          <p class="box-title">Ïò§ÎäòÏùò ÏÜåÎπÑ</p>
          <span class="sumchip" id="daySumChip">Ìï©Í≥Ñ 0Ïõê</span>
        </div>

        <div class="box-body">
          <div class="date-head">
            <p class="date-title" id="selectedDateTitle">ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî</p>
            <button class="btn-gray" id="addBtn" type="button">Ï∂îÍ∞Ä</button>
          </div>

          <div class="items" id="dayItems"></div>
        </div>
      </section>

      <!-- Box 3 -->
      <section class="box">
        <div class="box-head">
          <p class="box-title">Ïù¥Îã¨Ïùò ÏÜåÎπÑ</p>
          <span class="sumchip" id="monthSumChip">Ìï©Í≥Ñ 0Ïõê</span>
        </div>

        <div class="chart-wrap">
          <div class="cat-totals" id="monthCatTotals"></div>
          <canvas id="chart"></canvas>
          <div class="legend" id="legend"></div>
        </div>
      </section>
    </section>

    <!-- Annual -->
    <section class="annual" id="annualSection" style="display:none;">
      <div class="box-head">
        <p class="box-title">Ïó∞Îßê Ï†ïÏÇ∞(2026)</p>
        <span class="sumchip" id="yearSumChip">Ïó∞Í∞Ñ Ìï©Í≥Ñ 0Ïõê</span>
      </div>

      <div class="annual-body">
        <div class="annual-grid">
          <div>
            <p class="board-title" style="margin:0 0 8px;">Ìï≠Î™©Î≥Ñ Ïó∞Í∞Ñ Ìï©Í≥Ñ</p>
            <div class="cat-totals" id="yearCatTotals"></div>
          </div>

          <div>
            <p class="board-title" style="margin:0 0 8px;">ÏõîÎ≥Ñ Ï¥ù ÏßÄÏ∂ú</p>
            <canvas id="yearTotalLine"></canvas>
          </div>

          <div>
            <p class="board-title" style="margin:0 0 8px;">ÏõîÎ≥Ñ Ìï≠Î™© Íµ¨ÏÑ±</p>
            <canvas id="yearStackBar"></canvas>
            <div class="legend" id="yearLegend"></div>
          </div>
        </div>
      </div>
    </section>

    <div class="bottom-actions">
      <button id="exportBtn" type="button">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
      <label for="importFile" style="display:inline-flex; align-items:center; gap:8px;">
        <input id="importFile" type="file" accept="application/json" style="display:none;">
        <button type="button" id="importBtn">Í∞ÄÏ†∏Ïò§Í∏∞</button>
      </label>
      <button id="resetBtn" type="button">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <p class="modal-title" id="modalTitle">ÏÜåÎπÑ Ï∂îÍ∞Ä</p>
        <button class="iconbtn" id="closeModal" type="button" aria-label="Îã´Í∏∞">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="field">
          <label for="fDate">ÎÇ†Ïßú</label>
          <input id="fDate" type="date" />
        </div>

        <div class="field">
          <label for="fCat">Ìï≠Î™©</label>
          <select id="fCat">
            <option value="concert">Í≥µÏó∞</option>
            <option value="traffic">ÍµêÌÜµ</option>
            <option value="goods">ÍµøÏ¶à</option>
            <option value="stay">ÏàôÎ∞ï</option>
            <option value="sub">Ï†ïÍ∏∞Í≤∞Ï†ú</option>
          </select>
        </div>

        <div class="field">
          <label for="fAmt">Í∏àÏï°(Ïõê)</label>
          <input id="fAmt" type="number" min="0" step="100" placeholder="Ïòà: 23000" />
        </div>

        <div class="field">
          <label for="fNote">ÏÜåÎπÑ ÎÇ¥Ïö©</label>
          <textarea id="fNote" placeholder="Ïòà: Î¨∏Î≥Ñ ÏΩòÏÑúÌä∏ Ìã∞Ïºì / ÍµøÏ¶à Íµ¨Îß§"></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button id="deleteBtn" class="danger" type="button" style="display:none;">ÏÇ≠Ï†ú</button>
        <button id="cancelBtn" type="button">Ï∑®ÏÜå</button>
        <button id="saveBtn" class="accent" type="button">Ï†ÄÏû•</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Config
    ========================= */
    const BASE_BUDGET = 250000;
    const START_YEAR = 2026;
    const START_MONTH = 0; // Jan
    const YEAR = 2026;

    const CATS = [
      { key:"concert", label:"Í≥µÏó∞",  color:"var(--concert)" },
      { key:"traffic", label:"ÍµêÌÜµ",  color:"var(--traffic)" },
      { key:"goods",   label:"ÍµøÏ¶à",  color:"var(--goods)" },
      { key:"stay",    label:"ÏàôÎ∞ï",  color:"var(--stay)" },
      { key:"sub",     label:"Ï†ïÍ∏∞Í≤∞Ï†ú", color:"var(--sub)" }
    ];

    const catLabel = Object.fromEntries(CATS.map(c => [c.key, c.label]));
    const catColor = Object.fromEntries(CATS.map(c => [c.key, c.color]));

    /* =========================
       Canvas color resolver
       (so canvas can use CSS variables)
    ========================= */
    function resolveCssColor(value){
      if (!value) return "rgba(107,114,128,0.6)";
      const s = String(value).trim();
      if (!s.startsWith("var(")) return s;

      const name = s.slice(4, -1).trim();
      const real = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      return real || "rgba(107,114,128,0.6)";
    }

    /* =========================
       Storage
    ========================= */
    const KEY = "moonbyul_spending_v3";

    function loadTx(){
      try{
        const raw = localStorage.getItem(KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveTx(arr){
      localStorage.setItem(KEY, JSON.stringify(arr));
    }

    let tx = loadTx();

    /* =========================
       Utils
    ========================= */
    const pad = n => String(n).padStart(2,"0");
    const money = n => (Number(n)||0).toLocaleString("ko-KR") + "Ïõê";

    function keyOfDate(d){
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function ymKey(year, month){
      return `${year}-${pad(month+1)}`;
    }

    function parseDateKey(s){
      const [y,m,d] = String(s).split("-").map(Number);
      return new Date(y, (m||1)-1, d||1);
    }

    function clamp(n, a, b){
      return Math.max(a, Math.min(b, n));
    }

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function sumByMonth(year, month){
      const mk = ymKey(year, month);
      return tx
        .filter(t => String(t.date||"").slice(0,7) === mk)
        .reduce((s, t) => s + (Number(t.amount)||0), 0);
    }

    function sumByMonthCat(year, month, cat){
      const mk = ymKey(year, month);
      return tx
        .filter(t => String(t.date||"").slice(0,7) === mk && t.category === cat)
        .reduce((s, t) => s + (Number(t.amount)||0), 0);
    }

    function listByDate(dateKey){
      return tx
        .filter(t => t.date === dateKey)
        .sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
    }

    function safeMonthIter(fromYear, fromMonth, toYear, toMonth){
      const out = [];
      let y = fromYear, m = fromMonth;
      while (y < toYear || (y === toYear && m <= toMonth)){
        out.push([y,m]);
        m++;
        if (m>11){ m=0; y++; }
      }
      return out;
    }

    function computeBudgetFor(year, month){
      let balance = 0;
      let lastYear = null;
      
      const months = safeMonthIter(START_YEAR, START_MONTH, year, month);
      const table = {};

      for (const [y,m] of months){
        if(lastYear !== null && y !== lastYear){
          balance = 0;
        }
        lastYear = y;
        
        const budget = BASE_BUDGET + balance;
        const spent = sumByMonth(y,m);
        balance = budget - spent;
        
        table[ymKey(y,m)] = { budget, spent, balance, nextBudget: BASE_BUDGET + balance };
      }
      return table[ymKey(year,month)] || { budget: BASE_BUDGET, spent: 0, balance: BASE_BUDGET, nextBudget: BASE_BUDGET + BASE_BUDGET };
    }

    /* =========================
       View state
    ========================= */
    let view = new Date(START_YEAR, START_MONTH, 1);
    let selectedKey = keyOfDate(new Date(START_YEAR, START_MONTH, 1));

    (function initSelected(){
      const now = new Date();
      if (now.getFullYear() === YEAR){
        view = new Date(now.getFullYear(), now.getMonth(), 1);
        selectedKey = keyOfDate(now);
      }
    })();

    /* =========================
       Elements
    ========================= */
    const calendarEl = document.getElementById("calendar");
    const monthBtn = document.getElementById("monthBtn");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");

    const boardMonthTitle = document.getElementById("boardMonthTitle");
    const vBudget = document.getElementById("vBudget");
    const vSpent = document.getElementById("vSpent");
    const vRemain = document.getElementById("vRemain");
    const vNextBudget = document.getElementById("vNextBudget");
    const progressBar = document.getElementById("progressBar");

    const selectedDateTitle = document.getElementById("selectedDateTitle");
    const dayItemsEl = document.getElementById("dayItems");
    const addBtn = document.getElementById("addBtn");
    const daySumChip = document.getElementById("daySumChip");

    const monthCatTotalsEl = document.getElementById("monthCatTotals");
    const monthSumChip = document.getElementById("monthSumChip");

    const chartCanvas = document.getElementById("chart");
    const legendEl = document.getElementById("legend");

    const annualSection = document.getElementById("annualSection");
    const toggleYearBtn = document.getElementById("toggleYearBtn");
    const yearSumChip = document.getElementById("yearSumChip");
    const yearCatTotals = document.getElementById("yearCatTotals");
    const yearTotalLine = document.getElementById("yearTotalLine");
    const yearStackBar = document.getElementById("yearStackBar");
    const yearLegend = document.getElementById("yearLegend");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");
    const resetBtn = document.getElementById("resetBtn");

    // Modal
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const closeModal = document.getElementById("closeModal");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const fDate = document.getElementById("fDate");
    const fCat = document.getElementById("fCat");
    const fAmt = document.getElementById("fAmt");
    const fNote = document.getElementById("fNote");

    let editingId = null;
    let openCardId = null;

    /* =========================
       Calendar
    ========================= */
    function weeksInMonth(year, month){
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      return Math.ceil((first.getDay() + last.getDate()) / 7);
    }

    function dayDots(dateKey){
      const items = listByDate(dateKey);
      const set = new Set(items.map(i => i.category));
      return Array.from(set);
    }

    function renderCalendar(){
      calendarEl.innerHTML = "";

      const year = view.getFullYear();
      const month = view.getMonth();

      monthBtn.textContent = `${year}ÎÖÑ ${month+1}Ïõî`;

      const weeks = weeksInMonth(year, month);
      const total = weeks * 7;

      const first = new Date(year, month, 1);
      const start = new Date(year, month, 1 - first.getDay());

      const todayKey = keyOfDate(new Date());

      for (let i=0;i<total;i++){
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const key = keyOfDate(d);

        const cell = document.createElement("div");
        cell.className = "cell";
        if (d.getMonth() !== month) cell.classList.add("other-month");
        if (key === todayKey) cell.classList.add("today");
        if (key === selectedKey) cell.classList.add("selected");

        const top = document.createElement("div");
        top.className = "day";

        const num = document.createElement("span");
        num.textContent = d.getDate();

        top.appendChild(num);
        cell.appendChild(top);

        const dots = document.createElement("div");
        dots.className = "dots";
        dayDots(key).forEach(cat => {
          const dot = document.createElement("span");
          dot.className = "dot";
          dot.style.background = resolveCssColor(catColor[cat]) || "rgba(107,114,128,0.6)";
          dots.appendChild(dot);
        });
        cell.appendChild(dots);

        cell.onclick = () => {
          selectedKey = key;
          openCardId = null;
          renderSelectedDate();
          renderCalendar();
        };

        calendarEl.appendChild(cell);
      }
    }

    /* =========================
       Box2 (Ïò§ÎäòÏùò ÏÜåÎπÑ)
    ========================= */
    function renderSelectedDate(){
      const d = parseDateKey(selectedKey);
      selectedDateTitle.textContent = `${d.getFullYear()}ÎÖÑ ${d.getMonth()+1}Ïõî ${d.getDate()}Ïùº`;

      const items = listByDate(selectedKey);
      dayItemsEl.innerHTML = "";

      const daySum = items.reduce((s,t)=>s+(Number(t.amount)||0),0);
      daySumChip.textContent = `Ìï©Í≥Ñ ${money(daySum)}`;

      if (items.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "var(--muted)";
        empty.style.fontWeight = "800";
        empty.style.fontSize = "13px";
        empty.textContent = "Ïù¥ ÎÇ†ÏßúÏóêÎäî Í∏∞Î°ùÏù¥ ÏóÜÏñ¥Ïöî.";
        dayItemsEl.appendChild(empty);
        return;
      }

      items.forEach(it => {
        const card = document.createElement("div");
        card.className = "tx" + (openCardId === it.id ? " is-open" : "");
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");

        const content = document.createElement("div");
        content.className = "tx-content";

        const grid = document.createElement("div");
        grid.className = "tx-grid";

        const amt = document.createElement("div");
        amt.className = "tx-amt";
        amt.textContent = money(it.amount);

        const main = document.createElement("div");
        main.className = "tx-main";

        const title = document.createElement("p");
        title.className = "tx-title";
        title.textContent = it.note || "(ÎÇ¥Ïö© ÏóÜÏùå)";

        const meta = document.createElement("div");
        meta.className = "tx-meta";

        const pill = document.createElement("span");
        pill.className = "pill";

        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = resolveCssColor(catColor[it.category]) || "rgba(107,114,128,0.6)";

        pill.appendChild(dot);
        pill.appendChild(document.createTextNode(catLabel[it.category] || it.category));

        meta.appendChild(pill);

        main.appendChild(title);
        main.appendChild(meta);

        grid.appendChild(amt);
        grid.appendChild(main);
        content.appendChild(grid);

        const actions = document.createElement("div");
        actions.className = "tx-actions";

        const edit = document.createElement("button");
        edit.className = "iconbtn edit";
        edit.textContent = "ÏàòÏ†ï";
        edit.onclick = (e) => {
          e.stopPropagation();
          openEdit(it.id);
        };

        const del = document.createElement("button");
        del.className = "iconbtn del";
        del.textContent = "ÏÇ≠Ï†ú";
        del.onclick = (e) => {
          e.stopPropagation();
          if (!confirm("Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
          tx = tx.filter(t => t.id !== it.id);
          saveTx(tx);
          openCardId = null;
          rerenderAll();
        };

        actions.appendChild(edit);
        actions.appendChild(del);

        card.appendChild(content);
        card.appendChild(actions);

        card.onclick = () => {
          openCardId = (openCardId === it.id) ? null : it.id;
          renderSelectedDate();
        };

        card.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " "){
            e.preventDefault();
            card.click();
          }
        };

        dayItemsEl.appendChild(card);
      });
    }

    /* =========================
       Budget board
    ========================= */
    function renderBudgetBoard(){
      const year = view.getFullYear();
      const month = view.getMonth();

      const info = computeBudgetFor(year, month);

      boardMonthTitle.textContent = `${year}ÎÖÑ ${month+1}Ïõî ÏòàÏÇ∞`;

      vBudget.textContent = money(info.budget);
      vSpent.textContent = money(info.spent);

      const remain = info.balance;
      vRemain.textContent = (remain >= 0 ? money(remain) : "-" + money(Math.abs(remain)));
      vNextBudget.textContent = money(info.nextBudget);

      const pct = (info.budget > 0) ? (info.spent / info.budget) : 1;
      const pctClamped = clamp(pct, 0, 1);

      progressBar.style.width = `${pctClamped * 100}%`;

      const progressLeft = document.getElementById("progressLeft");
      const progressRight = document.getElementById("progressRight");

      progressLeft.textContent = `${Math.round(pctClamped * 100)}%`;
      progressRight.textContent = `${money(info.spent)} / ${money(info.budget)}`;

      if (pct > 1){
        progressBar.style.background = "rgba(239,68,68,0.55)";
      }else{
        progressBar.style.background = "rgba(124,58,237,0.65)";
      }
    }

    /* =========================
       Box3 (Ïù¥Îã¨Ïùò ÏÜåÎπÑ) + Bar chart
    ========================= */
    function renderMonthTotalsUI(){
      const year = view.getFullYear();
      const month = view.getMonth();

      monthCatTotalsEl.innerHTML = "";
      let total = 0;

      for (const c of CATS){
        const v = sumByMonthCat(year, month, c.key);
        total += v;

        const row = document.createElement("div");
        row.className = "cat-row";

        const left = document.createElement("div");
        left.className = "cat-left";

        const pill = document.createElement("span");
        pill.className = "pill";

        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = resolveCssColor(c.color);

        pill.appendChild(dot);
        pill.appendChild(document.createTextNode(c.label));

        left.appendChild(pill);

        const val = document.createElement("div");
        val.className = "cat-val";
        val.textContent = money(v);

        row.appendChild(left);
        row.appendChild(val);
        monthCatTotalsEl.appendChild(row);
      }

      monthSumChip.textContent = `Ìï©Í≥Ñ ${money(total)}`;
    }

    function setupCanvas(canvas){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      return ctx;
    }

    function clearCanvas(ctx, canvas){
      const w = canvas.getBoundingClientRect().width;
      const h = canvas.getBoundingClientRect().height;
      ctx.clearRect(0,0,w,h);
    }

    function drawMonthBar(){
      const ctx = setupCanvas(chartCanvas);
      clearCanvas(ctx, chartCanvas);

      const year = view.getFullYear();
      const month = view.getMonth();

      const cats = CATS;
      const values = cats.map(c => sumByMonthCat(year, month, c.key));
      const maxV = Math.max(1, ...values);

      const w = chartCanvas.getBoundingClientRect().width;
      const h = chartCanvas.getBoundingClientRect().height;

      const padL = 44;
      const padR = 14;
      const padT = 18;
      const padB = 44;

      ctx.strokeStyle = "rgba(107,114,128,0.35)";
      ctx.lineWidth = 1;

      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, h - padB);
      ctx.lineTo(w - padR, h - padB);
      ctx.stroke();

      const plotW = (w - padL - padR);
      const plotH = (h - padT - padB);

      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";

      for (let i=0;i<=3;i++){
        const y = padT + (plotH * i / 3);
        const v = Math.round(maxV * (1 - i/3));
        ctx.strokeStyle = "rgba(107,114,128,0.18)";
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(w - padR, y);
        ctx.stroke();

        ctx.fillStyle = "rgba(107,114,128,0.75)";
        ctx.fillText((v/10000>=1 ? (v/10000).toFixed(0)+"Îßå" : v.toLocaleString()), 6, y + 4);
      }

      const n = cats.length || 1;
      const gap = 12;
      const barW = (plotW - gap*(n+1)) / n;

      cats.forEach((c, i) => {
        const v = values[i] || 0;
        const x = padL + gap + i*(barW+gap);
        const vh = (v / maxV) * plotH;
        const y = padT + (plotH - vh);

        ctx.fillStyle = resolveCssColor(c.color);
        ctx.fillRect(x, y, barW, vh);

        ctx.fillStyle = "rgba(107,114,128,0.85)";
        const label = c.label;
        const tw = ctx.measureText(label).width;
        ctx.fillText(label, x + (barW - tw)/2, h - 18);

        ctx.fillStyle = "rgba(17,24,39,0.8)";
        const vText = v ? (v/10000>=1 ? (v/10000).toFixed(v%10000===0?0:1)+"Îßå" : v.toLocaleString()) : "";
        const vw = ctx.measureText(vText).width;
        ctx.fillText(vText, x + (barW - vw)/2, Math.max(14, y - 6));
      });
    }

    function renderLegend(){
      legendEl.innerHTML = CATS.map(c => `
        <div class="leg">
          <span class="dot" style="background:${resolveCssColor(c.color)}"></span>${c.label}
        </div>
      `).join("");
    }

    /* =========================
       Annual summary
    ========================= */
    function monthTotalsOfYear(year){
      const out = Array(12).fill(0);
      for (let m=0;m<12;m++){
        out[m] = sumByMonth(year, m);
      }
      return out;
    }

    function monthCatTotalsOfYear(year){
      const out = {};
      for (const c of CATS){
        out[c.key] = Array(12).fill(0);
        for (let m=0;m<12;m++){
          out[c.key][m] = sumByMonthCat(year, m, c.key);
        }
      }
      return out;
    }

    function renderAnnual(){
      const yearTotal = tx
        .filter(t => String(t.date||"").startsWith(String(YEAR)))
        .reduce((s,t)=>s+(Number(t.amount)||0),0);
      yearSumChip.textContent = `Ïó∞Í∞Ñ Ìï©Í≥Ñ ${money(yearTotal)}`;

      yearCatTotals.innerHTML = "";
      for (const c of CATS){
        const sum = tx
          .filter(t => String(t.date||"").startsWith(String(YEAR)) && t.category===c.key)
          .reduce((s,t)=>s+(Number(t.amount)||0),0);

        const row = document.createElement("div");
        row.className = "cat-row";

        const left = document.createElement("div");
        left.className = "cat-left";

        const pill = document.createElement("span");
        pill.className = "pill";

        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = resolveCssColor(c.color);

        pill.appendChild(dot);
        pill.appendChild(document.createTextNode(c.label));

        left.appendChild(pill);

        const val = document.createElement("div");
        val.className = "cat-val";
        val.textContent = money(sum);

        row.appendChild(left);
        row.appendChild(val);
        yearCatTotals.appendChild(row);
      }

      drawYearTotalLine();
      drawYearStackBar();
      renderYearLegend();
    }

    function drawYearTotalLine(){
      const ctx = setupCanvas(yearTotalLine);
      clearCanvas(ctx, yearTotalLine);

      const values = monthTotalsOfYear(YEAR);
      const maxV = Math.max(1, ...values);

      const w = yearTotalLine.getBoundingClientRect().width;
      const h = yearTotalLine.getBoundingClientRect().height;

      const padL = 44, padR = 14, padT = 18, padB = 44;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      ctx.strokeStyle = "rgba(107,114,128,0.35)";
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, h - padB);
      ctx.lineTo(w - padR, h - padB);
      ctx.stroke();

      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";

      for (let i=0;i<=3;i++){
        const y = padT + (plotH * i / 3);
        const v = Math.round(maxV * (1 - i/3));
        ctx.strokeStyle = "rgba(107,114,128,0.18)";
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(w - padR, y);
        ctx.stroke();

        ctx.fillStyle = "rgba(107,114,128,0.75)";
        ctx.fillText((v/10000>=1 ? (v/10000).toFixed(0)+"Îßå" : v.toLocaleString()), 6, y + 4);
      }

      for (let m=0;m<12;m++){
        const x = padL + (plotW * (m/11));
        ctx.fillStyle = "rgba(107,114,128,0.8)";
        ctx.fillText(String(m+1), x - 3, h - 18);
      }

      ctx.strokeStyle = "rgba(124,58,237,0.75)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let m=0;m<12;m++){
        const x = padL + (plotW * (m/11));
        const y = padT + (plotH - (values[m]/maxV)*plotH);
        if (m===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      ctx.fillStyle = "rgba(124,58,237,0.85)";
      for (let m=0;m<12;m++){
        const x = padL + (plotW * (m/11));
        const y = padT + (plotH - (values[m]/maxV)*plotH);
        ctx.beginPath();
        ctx.arc(x,y,3,0,Math.PI*2);
        ctx.fill();
      }
    }

    function drawYearStackBar(){
      const ctx = setupCanvas(yearStackBar);
      clearCanvas(ctx, yearStackBar);

      const catData = monthCatTotalsOfYear(YEAR);
      const monthTotals = monthTotalsOfYear(YEAR);
      const maxV = Math.max(1, ...monthTotals);

      const w = yearStackBar.getBoundingClientRect().width;
      const h = yearStackBar.getBoundingClientRect().height;

      const padL = 44, padR = 14, padT = 18, padB = 44;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      ctx.strokeStyle = "rgba(107,114,128,0.35)";
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, h - padB);
      ctx.lineTo(w - padR, h - padB);
      ctx.stroke();

      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";

      for (let i=0;i<=3;i++){
        const y = padT + (plotH * i / 3);
        const v = Math.round(maxV * (1 - i/3));
        ctx.strokeStyle = "rgba(107,114,128,0.18)";
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(w - padR, y);
        ctx.stroke();

        ctx.fillStyle = "rgba(107,114,128,0.75)";
        ctx.fillText((v/10000>=1 ? (v/10000).toFixed(0)+"Îßå" : v.toLocaleString()), 6, y + 4);
      }

      const n = 12;
      const gap = 6;
      const barW = (plotW - gap*(n+1)) / n;

      for (let m=0;m<12;m++){
        const x = padL + gap + m*(barW+gap);
        const total = monthTotals[m];

        let accH = 0;
        if (total > 0){
          for (const c of CATS){
            const v = catData[c.key][m] || 0;
            if (v <= 0) continue;

            const vh = (v / maxV) * plotH;
            const y = padT + (plotH - accH - vh);

            ctx.fillStyle = resolveCssColor(c.color);
            ctx.fillRect(x, y, barW, vh);

            accH += vh;
          }
        }

        ctx.fillStyle = "rgba(107,114,128,0.8)";
        ctx.fillText(String(m+1), x + Math.max(0,(barW-6)/2), h - 18);
      }
    }

    function renderYearLegend(){
      yearLegend.innerHTML = CATS.map(c => `
        <div class="leg">
          <span class="dot" style="background:${resolveCssColor(c.color)}"></span>${c.label}
        </div>
      `).join("");
    }

    /* =========================
       Modal CRUD
    ========================= */
    function openAdd(){
      editingId = null;
      modalTitle.textContent = "ÏÜåÎπÑ Ï∂îÍ∞Ä";
      deleteBtn.style.display = "none";

      fDate.value = selectedKey;
      fCat.value = "concert";
      fAmt.value = "";
      fNote.value = "";

      overlay.style.display = "flex";
    }

    function openEdit(id){
      const it = tx.find(t => t.id === id);
      if (!it) return;

      editingId = id;
      modalTitle.textContent = "ÏÜåÎπÑ ÏàòÏ†ï";
      deleteBtn.style.display = "inline-flex";

      fDate.value = it.date;
      fCat.value = it.category;
      fAmt.value = String(it.amount || "");
      fNote.value = it.note || "";

      overlay.style.display = "flex";
    }

    function close(){
      overlay.style.display = "none";
    }

    function saveFromModal(){
      const date = fDate.value;
      const category = fCat.value;
      const amount = Number(fAmt.value);
      const note = (fNote.value || "").trim();

      if (!date){ alert("ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî."); return; }
      if (!category){ alert("Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî."); return; }
      if (!Number.isFinite(amount) || amount <= 0){ alert("Í∏àÏï°ÏùÄ 1Ïõê Ïù¥ÏÉÅÏúºÎ°ú ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî."); return; }

      if (editingId){
        tx = tx.map(t => (t.id === editingId ? { ...t, date, category, amount, note } : t));
      }else{
        tx.push({ id: uid(), date, category, amount, note, createdAt: Date.now() });
      }

      saveTx(tx);

      const d = parseDateKey(date);
      view = new Date(d.getFullYear(), d.getMonth(), 1);
      selectedKey = date;
      openCardId = null;

      close();
      rerenderAll();
    }

    function deleteFromModal(){
      if (!editingId) return;
      if (!confirm("Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;

      tx = tx.filter(t => t.id !== editingId);
      saveTx(tx);
      editingId = null;
      openCardId = null;

      close();
      rerenderAll();
    }

    /* =========================
       Month navigation
    ========================= */
    function isCurrentMonth(d){
      const now = new Date();
      return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
    }

    function goMonth(diff){
      view = new Date(view.getFullYear(), view.getMonth() + diff, 1);

      const now = new Date();
      if (now.getFullYear() === YEAR && isCurrentMonth(view)){
        selectedKey = keyOfDate(now);
      }else{
        selectedKey = keyOfDate(new Date(view.getFullYear(), view.getMonth(), 1));
      }

      openCardId = null;
      rerenderAll();
    }

    function goCurrentMonth(){
      const now = new Date();
      if (now.getFullYear() !== YEAR){
        view = new Date(START_YEAR, START_MONTH, 1);
        selectedKey = keyOfDate(new Date(START_YEAR, START_MONTH, 1));
      }else{
        view = new Date(now.getFullYear(), now.getMonth(), 1);
        selectedKey = keyOfDate(now);
      }
      openCardId = null;
      rerenderAll();
    }

    /* =========================
       Backup / Restore
    ========================= */
    function exportJSON(){
      const data = { version: 3, exportedAt: new Date().toISOString(), tx };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `moonbyul_spending_${YEAR}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(String(reader.result || "{}"));
          const imported = Array.isArray(obj.tx) ? obj.tx : (Array.isArray(obj) ? obj : []);

          tx = imported
            .map(t => ({
              id: t.id || uid(),
              date: String(t.date || "").slice(0,10),
              category: String(t.category || ""),
              amount: Number(t.amount || 0),
              note: String(t.note || ""),
              createdAt: Number(t.createdAt || Date.now())
            }))
            .filter(t => /^\d{4}-\d{2}-\d{2}$/.test(t.date) && t.category && t.amount > 0);

          saveTx(tx);
          alert("Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å!");
          openCardId = null;
          rerenderAll();
        }catch(e){
          alert("Í∞ÄÏ†∏Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî. JSON ÌååÏùºÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.");
        }
      };
      reader.readAsText(file);
    }

    function resetAll(){
      if (!confirm("Ï†ïÎßê Ï†ÑÏ≤¥ Í∏∞Î°ùÏùÑ Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî? (ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏùå)")) return;
      tx = [];
      saveTx(tx);
      openCardId = null;
      rerenderAll();
    }

    /* =========================
       Rerender
    ========================= */
    function rerenderAll(){
      renderBudgetBoard();
      renderCalendar();
      renderSelectedDate();
      renderMonthTotalsUI();
      drawMonthBar();
      renderLegend();

      if (annualSection.style.display !== "none"){
        renderAnnual();
      }
    }

    /* =========================
       Events
    ========================= */
    prevMonthBtn.onclick = () => goMonth(-1);
    nextMonthBtn.onclick = () => goMonth(1);
    monthBtn.onclick = goCurrentMonth;

    addBtn.onclick = openAdd;

    closeModal.onclick = close;
    cancelBtn.onclick = close;
    overlay.addEventListener("click", (e) => { if (e.target === overlay) close(); });

    saveBtn.onclick = saveFromModal;
    deleteBtn.onclick = deleteFromModal;

    // toggle annual (text fixed)
    toggleYearBtn.textContent = "Ïó∞Í∞Ñ ÏöîÏïΩ Î≥¥Í∏∞";
    toggleYearBtn.onclick = () => {
      const isOpen = annualSection.style.display !== "none";
      if (isOpen){
        annualSection.style.display = "none";
        toggleYearBtn.classList.remove("btn-active");
      }else{
        annualSection.style.display = "block";
        toggleYearBtn.classList.add("btn-active");
        renderAnnual();
      }
    };

    exportBtn.onclick = exportJSON;
    importBtn.onclick = () => importFile.click();
    importFile.onchange = () => {
      if (importFile.files && importFile.files[0]){
        importJSON(importFile.files[0]);
        importFile.value = "";
      }
    };

    resetBtn.onclick = resetAll;

    window.addEventListener("resize", () => {
      drawMonthBar();
      if (annualSection.style.display !== "none"){
        renderAnnual();
      }
    });

    /* =========================
       Init
    ========================= */
    rerenderAll();
  </script>
</body>
</html>
